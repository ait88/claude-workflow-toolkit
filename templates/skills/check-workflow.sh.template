#!/usr/bin/env bash
# Skill: /check-workflow
# Description: Validate workflow state using optimized GraphQL queries
# Usage: /check-workflow

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get current branch
BRANCH=$(git branch --show-current)

if [[ -z "$BRANCH" ]]; then
    echo -e "${RED}Error: Not on a branch${NC}"
    exit 1
fi

# Extract issue number from branch name
ISSUE=$(echo "$BRANCH" | grep -oE '^[0-9]+' || echo "")

if [[ -z "$ISSUE" ]]; then
    echo -e "${YELLOW}Warning: Could not extract issue number from branch: ${BRANCH}${NC}"
    echo "Branch should be named: <issue-number>-description"
    echo ""
    echo -e "${GREEN}Workflow validation skipped (not on an issue branch)${NC}"
    exit 0
fi

echo "Validating workflow for issue #${ISSUE} on branch ${BRANCH}..."
echo ""

# Get repository info
REPO_INFO=$(gh repo view --json owner,name)
OWNER=$(echo "$REPO_INFO" | jq -r '.owner.login')
REPO=$(echo "$REPO_INFO" | jq -r '.name')

# Single GraphQL query to fetch all needed data
QUERY=$(cat <<EOF
query {
  repository(owner: "$OWNER", name: "$REPO") {
    issue(number: $ISSUE) {
      number
      title
      state
      labels(first: 20) {
        nodes {
          name
        }
      }
    }
    pullRequests(headRefName: "$BRANCH", first: 1, states: OPEN) {
      nodes {
        number
        state
      }
    }
  }
}
EOF
)

RESULT=$(gh api graphql -f query="$QUERY")

# Parse results
ISSUE_STATE=$(echo "$RESULT" | jq -r '.data.repository.issue.state')
ISSUE_TITLE=$(echo "$RESULT" | jq -r '.data.repository.issue.title')
LABELS=$(echo "$RESULT" | jq -r '.data.repository.issue.labels.nodes[].name' | tr '\n' ' ')
HAS_PR=$(echo "$RESULT" | jq -r '.data.repository.pullRequests.nodes | length > 0')
PR_NUMBER=$(echo "$RESULT" | jq -r '.data.repository.pullRequests.nodes[0].number // ""')

echo -e "${BLUE}Issue:${NC} #${ISSUE} - ${ISSUE_TITLE}"
echo -e "${BLUE}State:${NC} ${ISSUE_STATE}"
echo -e "${BLUE}Labels:${NC} ${LABELS:-"(none)"}"
if [[ "$HAS_PR" == "true" ]]; then
    echo -e "${BLUE}Pull Request:${NC} #${PR_NUMBER}"
fi
echo ""

# Validation
echo "========================================"
echo "Workflow Validation"
echo "========================================"
echo ""

ERRORS=0
WARNINGS=0

# Check issue state
if [[ "$ISSUE_STATE" == "CLOSED" ]]; then
    echo -e "${RED}CRITICAL:${NC} Issue is closed but you're on its branch"
    ((ERRORS++))
fi

# Check labels based on PR status
if [[ "$HAS_PR" == "true" ]]; then
    if echo "$LABELS" | grep -q "needs-review"; then
        echo -e "${GREEN}OK:${NC} Issue has 'needs-review' label (PR created)"
    else
        echo -e "${RED}ERROR:${NC} PR exists but issue doesn't have 'needs-review' label"
        echo "  Fix: gh issue edit $ISSUE --add-label \"needs-review\""
        ((ERRORS++))
    fi
    if echo "$LABELS" | grep -q "in-progress"; then
        echo -e "${YELLOW}WARNING:${NC} Issue has 'in-progress' but PR already created"
        echo "  Fix: gh issue edit $ISSUE --remove-label \"in-progress\""
        ((WARNINGS++))
    fi
else
    if echo "$LABELS" | grep -q "in-progress"; then
        echo -e "${GREEN}OK:${NC} Issue has 'in-progress' label (actively working)"
    else
        echo -e "${RED}ERROR:${NC} Working on issue but doesn't have 'in-progress' label"
        echo "  Fix: gh issue edit $ISSUE --add-label \"in-progress\""
        ((ERRORS++))
    fi
    if echo "$LABELS" | grep -q "agent-ready"; then
        echo -e "${YELLOW}WARNING:${NC} Issue still has 'agent-ready' label"
        echo "  Fix: gh issue edit $ISSUE --remove-label \"agent-ready\""
        ((WARNINGS++))
    fi
fi

# Check for phase labels
if ! echo "$LABELS" | grep -qE '{{PHASE_PREFIX}}[0-9]+'; then
    echo -e "${YELLOW}WARNING:${NC} Issue doesn't have a phase label"
    ((WARNINGS++))
fi

echo ""
echo "========================================"

if [[ $ERRORS -eq 0 && $WARNINGS -eq 0 ]]; then
    echo -e "${GREEN}All checks passed!${NC}"
elif [[ $ERRORS -eq 0 ]]; then
    echo -e "${YELLOW}$WARNINGS warning(s) found${NC}"
    exit 0
else
    echo -e "${RED}$ERRORS error(s), $WARNINGS warning(s) found${NC}"
    exit 1
fi

#!/usr/bin/env bash
# Skill: /submit-pr
# Description: Create PR and update issue labels atomically
# Usage: /submit-pr [--project <path>] [title] [body]

set -euo pipefail

# ============================================================================
# WORKSPACE/PROJECT MODE DETECTION
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_PROJECT=""
TARGET_REPO_OWNER=""
TARGET_REPO_NAME=""
MODE=""
REMAINING_ARGS=()

_parse_project_flag() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --project|-p)
                if [[ -n "${2:-}" ]]; then
                    TARGET_PROJECT="$2"
                    shift 2
                else
                    echo "Error: --project requires a path argument"
                    exit 1
                fi
                ;;
            --repo|-r)
                if [[ -n "${2:-}" ]]; then
                    TARGET_REPO_OWNER="${2%%/*}"
                    TARGET_REPO_NAME="${2##*/}"
                    shift 2
                else
                    echo "Error: --repo requires owner/name argument"
                    exit 1
                fi
                ;;
            *)
                REMAINING_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

_load_workspace_config() {
    local config_file="${SCRIPT_DIR}/../workspace-config"
    if [[ -f "$config_file" ]]; then
        # shellcheck source=/dev/null
        source "$config_file"
        TARGET_PROJECT="${TARGET_PROJECT_PATH:-}"
        TARGET_REPO_OWNER="${TARGET_REPO_OWNER:-}"
        TARGET_REPO_NAME="${TARGET_REPO_NAME:-}"
        return 0
    fi
    return 1
}

_detect_mode() {
    if [[ -n "$TARGET_PROJECT" ]] || [[ -n "$TARGET_REPO_OWNER" ]]; then
        MODE="explicit"
        return
    fi
    if _load_workspace_config; then
        MODE="workspace"
        return
    fi
    if git rev-parse --git-dir > /dev/null 2>&1; then
        TARGET_PROJECT="$(pwd)"
        MODE="in-project"
        return
    fi
    echo "Error: Not in a git repository and no workspace config found."
    echo ""
    echo "Options:"
    echo "  1. Run from within the target project directory"
    echo "  2. Use --project <path> flag"
    echo "  3. Create .claude/workspace-config with TARGET_PROJECT_PATH"
    exit 1
}

_get_repo_info() {
    if [[ -n "$TARGET_REPO_OWNER" ]] && [[ -n "$TARGET_REPO_NAME" ]]; then
        OWNER="$TARGET_REPO_OWNER"
        REPO="$TARGET_REPO_NAME"
    else
        local repo_info
        if [[ -n "$TARGET_PROJECT" ]] && [[ "$MODE" != "in-project" ]]; then
            repo_info=$(cd "$TARGET_PROJECT" && gh repo view --json owner,name)
        else
            repo_info=$(gh repo view --json owner,name)
        fi
        OWNER=$(echo "$repo_info" | jq -r '.owner.login')
        REPO=$(echo "$repo_info" | jq -r '.name')
    fi
}

_git() {
    if [[ "$MODE" == "in-project" ]]; then
        git "$@"
    else
        git -C "$TARGET_PROJECT" "$@"
    fi
}

_parse_project_flag "$@"
set -- "${REMAINING_ARGS[@]+"${REMAINING_ARGS[@]}"}"
_detect_mode
_get_repo_info

# ============================================================================
# END MODE DETECTION
# ============================================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get current branch
BRANCH=$(_git branch --show-current)

if [[ -z "$BRANCH" ]]; then
    echo -e "${RED}Error: Not on a branch${NC}"
    exit 1
fi

# Prevent PR from default branch
if [[ "$BRANCH" == "{{DEFAULT_BRANCH}}" || "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
    echo -e "${RED}Error: Cannot create PR from ${BRANCH} branch${NC}"
    exit 1
fi

# Extract issue number
ISSUE=$(echo "$BRANCH" | grep -oE '^[0-9]+' || echo "")

if [[ -z "$ISSUE" ]]; then
    echo -e "${YELLOW}Warning: Could not extract issue number from branch: ${BRANCH}${NC}"
    echo "Branch should be named: <issue-number>-description"
    read -p "Enter issue number (or press Enter to skip): " ISSUE
fi

echo "Submitting PR for branch ${BRANCH}..."

# Check for uncommitted changes
if [[ -n $(_git status --porcelain) ]]; then
    echo -e "${YELLOW}Warning: You have uncommitted changes${NC}"
    _git status --short
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi
fi

# Helper function for SSH/HTTPS fallback
git_with_fallback() {
    local cmd="$1"
    shift
    if ! _git "$cmd" "$@" 2>/dev/null; then
        echo "SSH failed, trying HTTPS via gh auth..."
        gh auth setup-git 2>/dev/null || true
        _git "$cmd" "$@"
    fi
}

# Push branch
echo "Pushing branch..."
git_with_fallback push -u origin "$BRANCH" || {
    echo -e "${RED}Error: Failed to push branch${NC}"
    exit 1
}

# Check for existing PR (using explicit repo)
EXISTING_PR=$(gh pr list --repo "$OWNER/$REPO" --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

if [[ -n "$EXISTING_PR" ]]; then
    echo -e "${YELLOW}PR #${EXISTING_PR} already exists for this branch${NC}"
    PR_URL=$(gh pr view "$EXISTING_PR" --repo "$OWNER/$REPO" --json url --jq '.url')
    echo "URL: $PR_URL"
else
    # Create PR
    echo "Creating pull request..."

    TITLE="${1:-}"
    BODY="${2:-}"

    # Build PR body
    PR_BODY=""
    if [[ -n "$ISSUE" ]]; then
        PR_BODY="Closes #${ISSUE}"
    fi
    if [[ -n "$BODY" ]]; then
        if [[ -n "$PR_BODY" ]]; then
            PR_BODY="${BODY}

${PR_BODY}"
        else
            PR_BODY="$BODY"
        fi
    fi

    if [[ -z "$TITLE" ]]; then
        # Auto-generate from commits
        if [[ -n "$PR_BODY" ]]; then
            PR_URL=$(gh pr create --repo "$OWNER/$REPO" --fill --body "$PR_BODY" 2>&1)
        else
            PR_URL=$(gh pr create --repo "$OWNER/$REPO" --fill 2>&1)
        fi
    else
        if [[ -n "$PR_BODY" ]]; then
            PR_URL=$(gh pr create --repo "$OWNER/$REPO" --title "$TITLE" --body "$PR_BODY" 2>&1)
        else
            PR_URL=$(gh pr create --repo "$OWNER/$REPO" --title "$TITLE" --body "" 2>&1)
        fi
    fi

    echo -e "${GREEN}PR created:${NC} $PR_URL"
fi

# Update issue labels if we have an issue number (using explicit repo)
if [[ -n "$ISSUE" ]]; then
    echo "Updating issue labels..."
    gh issue edit "$ISSUE" --repo "$OWNER/$REPO" --remove-label "in-progress" --add-label "needs-review" 2>/dev/null || {
        gh issue edit "$ISSUE" --repo "$OWNER/$REPO" --add-label "needs-review" 2>/dev/null || true
    }
    echo "Issue #${ISSUE} now has 'needs-review' label"
fi

echo ""
echo -e "${GREEN}PR submitted successfully${NC}"
echo ""
echo "Next steps:"
echo "  1. Wait for code review"
echo "  2. Address any feedback"
echo "  3. Merge when approved"
